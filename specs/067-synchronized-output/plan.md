# Implementation Plan: Synchronized Output (DEC Mode 2026)

**Branch**: `067-synchronized-output` | **Date**: 2026-02-07 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/067-synchronized-output/spec.md`

## Summary

Eliminate terminal resize flicker by wrapping all render flushes in DEC Private Mode 2026 (Synchronized Output) escape sequences and deferring the erase operation from the resize handler to the next render cycle. This is a two-part fix: (1) add `BeginSynchronizedOutput()`/`EndSynchronizedOutput()` to `IOutput` and all 7 implementations, wrapping `Renderer.Render()`, `Erase()`, and `Clear()` in synchronized output blocks; (2) replace the immediate `Erase()` call in `OnResize()` with a state-only `ResetForResize()` method, and use absolute cursor positioning (`CSI H`) in the full-redraw path.

## Technical Context

**Language/Version**: C# 13 / .NET 10+
**Primary Dependencies**: None new — internal rendering pipeline changes only
**Storage**: N/A (in-memory rendering state)
**Testing**: xUnit (no mocks per Constitution VIII)
**Target Platform**: Linux, macOS, Windows 10+ (cross-platform)
**Project Type**: Single project (Stroke library + test project)
**Performance Goals**: < 20 bytes overhead per render cycle (NFR-001)
**Constraints**: Zero regressions in 9,311+ existing tests (NFR-003)
**Scale/Scope**: 10 modified files, 2 new test files, ~200 lines of new/changed code

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Faithful Port | ✅ PASS | Python PTK has no synchronized output. This is a documented enhancement (no API changes). See [research.md](research.md) R-002. |
| II. Immutability | ✅ PASS | No new data structures. `_synchronizedOutput` is a mutable flag in mutable `Vt100Output` class. |
| III. Layered Architecture | ✅ PASS | Changes span Output (layer 2) and Rendering (layer 2), with one touch point in Application (layer 7). All dependencies flow downward. |
| IV. Cross-Platform | ✅ PASS | VT100 backends emit Mode 2026; Win32/PlainText/Dummy no-op. Unsupported terminals silently ignore per DEC spec. |
| V. Editing Mode Parity | ✅ N/A | No editing mode changes. |
| VI. Performance | ✅ PASS | 16 bytes overhead per render (8-byte begin + 8-byte end marker). Well under 20-byte limit. |
| VII. Full Scope | ✅ PASS | All 17 FRs and 5 NFRs addressed. No deferral. |
| VIII. Real-World Testing | ✅ PASS | Tests use real `Vt100Output` with `StringWriter` capture. No mocks. |
| IX. Planning Documents | ✅ PASS | `BeginSynchronizedOutput`/`EndSynchronizedOutput` not in api-mapping.md (new enhancement). |
| X. File Size | ✅ PASS | All modified files remain under 1,000 LOC. Largest: Application.RunAsync.cs at 719 LOC. |
| XI. Thread Safety | ✅ PASS | `_synchronizedOutput` flag protected by existing `_lock` in Vt100Output (FR-015). |
| XII. Contracts in Markdown | ✅ PASS | All contracts in `contracts/*.md` files. |

**Post-design re-check**: ✅ All gates still pass after Phase 1 design completion.

## Project Structure

### Documentation (this feature)

```text
specs/067-synchronized-output/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Phase 0 research findings
├── data-model.md        # Entity model and data flows
├── quickstart.md        # Build/test/verify guide
├── contracts/
│   ├── ioutput-extension.md    # IOutput interface extension contract
│   └── renderer-extension.md   # Renderer integration contract
├── checklists/
│   └── requirements.md  # Spec quality checklist
└── tasks.md             # Task list (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
src/Stroke/
├── Output/
│   ├── IOutput.cs                           # +2 interface methods
│   ├── Vt100Output.cs                       # +flag, modified Flush()
│   ├── PlainTextOutput.cs                   # +2 no-op methods
│   ├── DummyOutput.cs                       # +2 no-op methods
│   └── Windows/
│       ├── Win32Output.cs                   # +2 no-op methods
│       ├── Windows10Output.cs               # +2 delegation methods
│       └── ConEmuOutput.cs                  # +2 delegation methods
├── Rendering/
│   ├── Renderer.cs                          # +ResetForResize(), wrap Render/Erase/Clear
│   └── Renderer.Diff.cs                     # Absolute cursor home on full redraw
└── Application/
    └── Application.RunAsync.cs              # OnResize() → ResetForResize()

tests/Stroke.Tests/
├── Output/
│   └── Vt100OutputSynchronizedOutputTests.cs  # NEW: Sync output unit tests
└── Rendering/
    └── RendererSynchronizedOutputTests.cs     # NEW: Renderer integration tests
```

**Structure Decision**: Existing single-project structure. All changes modify existing files in established directories. Two new test files follow the existing namespace-based directory convention.

## Complexity Tracking

> No constitution violations. No complexity justification needed.
