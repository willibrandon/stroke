# Implementation Plan: Tutorial Example (SQLite CLI)

**Branch**: `069-tutorial-sqlite-cli` | **Date**: 2026-02-08 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/069-tutorial-sqlite-cli/spec.md`

## Summary

Implement the final Python Prompt Toolkit tutorial example — an interactive SQLite REPL — as `Stroke.Examples.Tutorial/SqliteCli.cs`. This example composes four Stroke APIs (`PromptSession`, `WordCompleter`, `PygmentsLexer.FromFilename`, `Style.FromDict`) with `Microsoft.Data.Sqlite` to deliver a complete database shell with syntax highlighting, tab completion, and styled menus. It completes 128/128 applicable example ports (100% coverage).

## Technical Context

**Language/Version**: C# 13 / .NET 10
**Primary Dependencies**: Stroke (project reference), Microsoft.Data.Sqlite (NuGet v9.*)
**Storage**: SQLite — in-memory (`:memory:`) by default, optional file-based via CLI argument
**Testing**: TUI Driver (interactive verification), xUnit not required for example projects
**Target Platform**: Linux, macOS, Windows 10+
**Project Type**: Single console application (example project)
**Performance Goals**: N/A (example/tutorial code)
**Constraints**: Must faithfully match Python `sqlite-cli.py` behavior
**Scale/Scope**: 3 files (SqliteCli.cs, Program.cs, .csproj), ~120 LOC total

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Faithful Port | PASS | Direct 1:1 port of `examples/tutorial/sqlite-cli.py` |
| II. Immutability | N/A | Example code only — no new library types |
| III. Layered Architecture | PASS | Example project depends on Stroke.Shortcuts (layer 8) — allowed |
| IV. Cross-Platform | PASS | Uses PromptSession + Microsoft.Data.Sqlite — both cross-platform |
| V. Editing Mode Parity | N/A | Example uses default Emacs mode |
| VI. Performance | N/A | Example code — no rendering changes |
| VII. Full Scope | PASS | All 17 functional requirements will be implemented |
| VIII. Real-World Testing | PASS | TUI Driver verification planned; no mocks |
| IX. Planning Documents | PASS | Matches `docs/examples-mapping.md` row 128: `tutorial/sqlite-cli.py` → `Tutorial/SqliteCli.cs` |
| X. File Size | PASS | SqliteCli.cs ~90 LOC, Program.cs ~30 LOC — well under 1,000 |
| XI. Thread Safety | N/A | Example code — no mutable shared state |

All gates pass. No violations to justify.

## Project Structure

### Documentation (this feature)

```text
specs/069-tutorial-sqlite-cli/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Phase 0 research
├── data-model.md        # Phase 1 data model
├── quickstart.md        # Phase 1 quickstart guide
├── contracts/           # Phase 1 API contracts
│   └── sqlitecli.md     # SqliteCli class contract
└── tasks.md             # Phase 2 task list (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
examples/
├── Stroke.Examples.sln                      # Add Tutorial project reference
└── Stroke.Examples.Tutorial/
    ├── Stroke.Examples.Tutorial.csproj       # Project file with Stroke + Microsoft.Data.Sqlite
    ├── Program.cs                           # Dictionary-based example routing
    └── SqliteCli.cs                         # SQLite REPL implementation
```

**Structure Decision**: Single example project following the established pattern from all other 8 example projects. Program.cs parses the database argument (matching Python's `if __name__` block) and calls `SqliteCli.Run(database)` (matching Python's `main(database)`).

## Complexity Tracking

No violations to track. This is a straightforward example project with minimal complexity.

## Key Design Decisions

### 1. SQL Lexer Approach

Use `PygmentsLexer.FromFilename("example.sql")` — the same pattern used by `HtmlInput.cs` (`PygmentsLexer.FromFilename("example.html")`). This delegates to `TextMateLineLexer.FromExtension(".sql")` internally.

**Python equivalent**: `PygmentsLexer(SqlLexer)` — Stroke doesn't have individual lexer classes; it uses TextMate grammar detection via file extensions.

### 2. Row Output Format

Python prints raw tuples: `print(message)` where `message` is a `sqlite3.Row` tuple. Python's `str(tuple)` calls `repr()` on each element, producing output like `(1, 'alice', 3.14)` — strings are single-quoted, integers and floats are bare, NULL renders as `None`, and single-element tuples have a trailing comma: `(42,)`.

The C# port MUST match this behavior exactly. Since `SqliteDataReader` returns typed values, we format each column value according to Python's `repr()` rules:
- `string` → single-quoted: `'alice'`
- `long` (INTEGER) → bare: `1`
- `double` (REAL) → bare: `3.14`
- `DBNull.Value` (NULL) → `None`
- Single-column rows → trailing comma: `(42,)`
- Multi-column rows → no trailing comma: `(1, 'alice')`

### 3. Error Display

Python uses `print(repr(e))` which outputs `TypeName('message')` — e.g., `OperationalError('near "INVALID": syntax error')`. The C# port MUST match this format exactly: `Console.WriteLine($"{e.GetType().Name}('{e.Message}')");`. This produces output like `SqliteException('near "INVALID": syntax error')`, faithfully matching the Python `repr(e)` structure.

**Rejected alternatives**:
- `Console.WriteLine(e)` — outputs full stack trace, not matching Python
- `Console.WriteLine(e.Message)` — loses type information present in `repr(e)`

### 4. Database Connection Scope

Python uses `connection = sqlite3.connect(database)` once, then `with connection:` for each query. The `with connection:` context manager begins a transaction; on normal exit it commits, on exception it rolls back. However, since the `except` clause inside the `with` block catches all exceptions, the transaction always commits (failed SQL statements have nothing to commit — this is a no-op).

C# equivalent: open the connection once with `using var connection`, keep it open for the REPL session lifetime, and dispose on exit. Microsoft.Data.Sqlite auto-commits individual statements when not in an explicit transaction, which provides equivalent behavior for single-statement execution. The connection MUST stay open for the entire session (closing it would destroy in-memory databases).

### 5. Solution File Inclusion

The Stroke.Examples.sln currently has 6 example projects (Prompts, Choices, Dialogs, FullScreen, PrintText, ProgressBar) plus the Stroke library. Telnet and SSH example projects exist but were omitted from the solution — they MUST be added alongside Tutorial to comply with Constitution §VII (Full Scope). After this feature, the solution will have 9 example projects.
