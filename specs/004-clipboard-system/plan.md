# Implementation Plan: Clipboard System

**Branch**: `004-clipboard-system` | **Date**: 2026-01-23 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/004-clipboard-system/spec.md`

## Summary

Implement the clipboard abstraction and implementations for storing and retrieving text with selection type information. This includes `ClipboardData` (already exists), `IClipboard` interface, `DummyClipboard`, `InMemoryClipboard` with kill ring support, and `DynamicClipboard` with fallback behavior. The implementation must faithfully port Python Prompt Toolkit's clipboard module semantics.

## Technical Context

**Language/Version**: C# 13 / .NET 10
**Primary Dependencies**: None (Stroke.Core layer has zero external dependencies)
**Storage**: In-memory only (no persistence)
**Testing**: xUnit (no mocks, no FluentAssertions per Constitution VIII)
**Target Platform**: Cross-platform (.NET 10 - Linux, macOS, Windows 10+)
**Project Type**: Single library project
**Performance Goals**: O(1) for all clipboard operations (SetData, GetData, SetText, Rotate)
**Constraints**: Thread safety REQUIRED for mutable implementations (deviation from Python per Constitution XI)
**Scale/Scope**: Kill ring max size default 60 items, configurable

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Faithful Port (100% API Fidelity) | ✅ PASS | All APIs match Python Prompt Toolkit: ClipboardData, Clipboard (→ IClipboard), DummyClipboard, DynamicClipboard, InMemoryClipboard |
| II. Immutability by Default | ✅ PASS | ClipboardData is immutable (sealed class, get-only properties). Kill ring stores immutable ClipboardData items. |
| III. Layered Architecture | ✅ PASS | Clipboard resides in Stroke.Core layer with zero external dependencies. Depends only on SelectionType from Stroke.Core.Selection. |
| IV. Cross-Platform Terminal Compatibility | ✅ PASS | N/A for clipboard abstraction (in-memory storage is platform-agnostic). |
| V. Complete Editing Mode Parity | ✅ PASS | Kill ring supports Emacs yank-pop; Selection types support Vi line/block selections. |
| VI. Performance-Conscious Design | ✅ PASS | All operations O(1) using LinkedList for kill ring. No global mutable state. |
| VII. Full Scope Commitment | ✅ PASS | All 5 types will be implemented: ClipboardData, IClipboard, DummyClipboard, InMemoryClipboard, DynamicClipboard |
| VIII. Real-World Testing | ✅ PASS | Tests use xUnit with real implementations only. No mocks. |
| IX. Adherence to Planning Documents | ✅ PASS | Following docs/api-mapping.md: Clipboard → IClipboard interface |
| X. Source Code File Size Limits | ✅ PASS | Each file is small (<100 LOC expected per file) |
| XI. Thread Safety by Default | ✅ PASS | InMemoryClipboard uses System.Threading.Lock; DummyClipboard stateless; ClipboardData immutable |

## Project Structure

### Documentation (this feature)

```text
specs/004-clipboard-system/
├── plan.md              # This file
├── research.md          # Phase 0 output
├── data-model.md        # Phase 1 output
├── quickstart.md        # Phase 1 output
├── contracts/           # Phase 1 output (N/A - no APIs)
└── tasks.md             # Phase 2 output (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
src/Stroke/
└── Core/
    ├── ClipboardData.cs        # Already exists - text + selection type
    ├── IClipboard.cs           # NEW - interface for clipboard operations
    ├── DummyClipboard.cs       # NEW - no-op implementation
    ├── InMemoryClipboard.cs    # NEW - kill ring implementation
    └── DynamicClipboard.cs     # NEW - dynamic wrapper

tests/Stroke.Tests/
└── Core/
    ├── ClipboardDataTests.cs       # Already exists (Phase 11 - T142)
    ├── DummyClipboardTests.cs      # NEW
    ├── InMemoryClipboardTests.cs   # NEW
    └── DynamicClipboardTests.cs    # NEW
```

**Structure Decision**: Single library project structure. Clipboard types reside in `Stroke.Core` namespace alongside existing `ClipboardData`, `SelectionType`, and `Document` classes. This follows the existing project layout and Constitution Principle III (Layered Architecture).

## Complexity Tracking

> No violations. All Constitution gates pass.

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| None | N/A | N/A |
